/*!
 * Socky JavaScript Library
 *
 * @version 0.5.0-pre
 * @author  Bernard Potocki <bernard.potocki@imanel.org>
 * @licence The MIT licence.
 * @source  http://github.com/socky/socky-js
 */

if(typeof Function.prototype.scopedTo=="undefined")Function.prototype.scopedTo=function(a,b){var f=this;return function(){return f.apply(a,Array.prototype.slice.call(b||[]).concat(Array.prototype.slice.call(arguments)))}};var Socky=function(a){this.options=a||{};this.connected=false;this.connection_id=null;SockyManager.is_driver_loaded()&&this.connect();SockyManager.add_socky_instance.push(this)};
Socky.prototype={connect:function(){var a=this;if(window.WebSocket){var b=SockyManager.websocket_url();Socky.log("connecting",b);b=new WebSocket(b);b.onopen=function(){a.onopen.apply(a,arguments)};b.onmessage=function(){a.onmessage.apply(a,arguments)};b.onclose=function(){a.onclose.apply(a,arguments)};this._connection=b}else{Socky.log("WebSocket unavailable");this._connection={}}},onopen:function(){Socky.log("connected")},onmessage:function(a){Socky.log("received message",a.data)},onclose:function(){Socky.log("disconnected")}};
var SockyManager={_is_websocket_driver_loaded:false,_socky_instances:[],_default_options:{assets_location:"<CDN_LOCATION>",app_name:"",websocket_debug:false,websocket_path:"/socket",websocket_host:window.location.hostname,websocket_port:8080,websocket_secure:false},log:function(){if(console&&console.log){for(var a=["Socky"],b=0;b<arguments.length;b++)a.push(arguments[b]);console.log(a.join(" : "))}},is_driver_loaded:function(){return SockyManager._is_websocket_driver_loaded},add_socky_instance:function(a){SockyManager._socky_instances.push(a)},
websocket_url:function(){var a="ws";if(SockyManager._options.websocket_secure)a+="s";a+="://"+SockyManager._options.websocket_host+":"+SockyManager._options.websocket_port+SockyManager._options.websocket_path+"/"+SockyManager._options.app_name;return a},init:function(a){SockyManager._options=SockyManager._default_options;for(option in a)SockyManager._options[option]=a[option];a=[];window.JSON==undefined&&a.push(SockyManager._options.assets_location+"/json2.min.js");var b=null;if(window.WebSocket==
undefined){window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=true;window.WEB_SOCKET_SWF_LOCATION=SockyManager._options.assets_location+"/WebSocketMain.swf";window.WEB_SOCKET_DEBUG=SockyManager._options.websocket_debug;a.push(SockyManager._options.assets_location+"/flashfallback.min.js");b=function(){FABridge.addInitializationCallback("webSocket",function(){SockyManager._web_sockets_loaded()});window.WebSocket?WebSocket.__initialize():SockyManager.log("Could not connect","WebSocket is not availabe natively nor via Flash")}}else b=
function(){SockyManager._web_sockets_loaded()};a.length>0?_require(a,callback):b()},_web_sockets_loaded:function(){SockyManager._is_websocket_driver_loaded=true;for(var a=0;a<Socky.instances.length;a++){var b=SockyManager._socky_instances[a];b.is_connected()||b.connect()}},_require_scripts:function(a,b){function f(c,d){d=d||function(){};var i=document.getElementsByTagName("head")[0],e=document.createElement("script");e.setAttribute("src",c);e.setAttribute("type","text/javascript");e.setAttribute("async",
true);h(e,function(){var j=d;scripts_count++;a.length==scripts_count&&setTimeout(j,0)});i.appendChild(e)}var h;h=document.addEventListener?function(c,d){c.addEventListener("load",d,false)}:function(c,d){c.attachEvent("onreadystatechange",function(){if(c.readyState=="loaded"||c.readyState=="complete")d()})};for(var g=0;g<a.length;g++)f(a[g],b)}};
